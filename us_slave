#include "stm32f4xx.h"
#include "lcd.h"
#include <stdint.h>

// Initialize USART3 on PC11 (RX) and PC10 (TX)
void usart3_init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOCEN;
    RCC->APB1ENR |= RCC_APB1ENR_USART3EN;

    // PC11 (RX)
    GPIOC->MODER &= ~(3 << (2 * 11));
    GPIOC->MODER |=  (2 << (2 * 11));
    GPIOC->AFR[1] &= ~(0xF << ((11 - 8) * 4));
    GPIOC->AFR[1] |=  (7 << ((11 - 8) * 4));  // AF7 for RX

    // PC10 (TX)
    GPIOC->MODER &= ~(3 << (2 * 10));
    GPIOC->MODER |=  (2 << (2 * 10));
    GPIOC->AFR[1] &= ~(0xF << ((10 - 8) * 4));
    GPIOC->AFR[1] |=  (7 << ((10 - 8) * 4));  // AF7 for TX

    USART3->BRR = 0x683;  // Baud rate 9600 (16MHz clock)
    USART3->CR1 |= USART_CR1_RE | USART_CR1_TE;  // Enable RX and TX
    USART3->CR1 |= USART_CR1_UE;  // Enable USART
}

// Blocking USART3 character read
uint8_t usart3_read_char(void) {
    while (!(USART3->SR & USART_SR_RXNE));
    return (uint8_t)USART3->DR;
}

// Blocking USART3 character write
void usart3_send_char(char c) {
    while (!(USART3->SR & USART_SR_TXE));
    USART3->DR = c;
}

// Send a string over USART3
void usart3_send_string(const char *str) {
    while (*str) {
        usart3_send_char(*str++);
    }
}

int main(void) {
    lcd_gpio_init();
    lcd_init();
    usart3_init();

    lcd(0x01, 0);
    lcd_string("Receiver Ready");

    char buffer[32];
    uint8_t idx = 0;
    char c;

    while (idx < sizeof(buffer) - 1) {
        c = usart3_read_char();
        if (c == '\r' || c == '\n') break;
        buffer[idx++] = c;
    }
    buffer[idx] = '\0';

    lcd(0x01, 0);
    lcd_string("Received:");
    lcd(0xC0, 0);
    lcd_string(buffer);

    // Send ACK to master
    usart3_send_string("OK\r\n");

    while (1);
}
